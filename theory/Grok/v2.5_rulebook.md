### Updated v2.5 Rulebook (Full Integration)
This is the complete, updated system (v2.5), merging base v2, refinements A–N. Changes from v2.3: Added J (event override), K (high-IV boost), L (correlation veto), M (DTE-weighted IV filter), N (sustained trigger counter). ~25% denser but programmatic/simplicity-rewarding. Test via Monk on 5y data (Sharpe >1.0, DD <15%).

#### Instruments
- Primary: NIFTY options (weekly/monthly, 30-delta shorts).  
- Secondary: Commodities (Goldm, Silverm, Crude, NaturalGas) if corr to NIFTY < |0.4| (20-day); stocks (e.g., RELIANCE) if < |0.6|.  
- Max concurrent: 4 (2 NIFTY + 2 secondary; no expiry overlap).  
- Filter: Liquidity (bid-ask <0.5% premium); avoid <3 days expiry for shorts.

#### Structures
- Short-vol: 30-delta strangles/condors (IV <15th percentile; auto-adjust per Refs A/H/K).  
- Directional: Risk-reversals/pairs (e.g., NIFTY call + Goldm put) for mean-reversion/trend.  
- Hedging: On Greeks breach (buy ATM straddle if gamma >0.02/vega >+5%; probabilistic per Ref H).  
- All: Max 7-day hold unless patience-extended (Ref C); no naked.

#### Regime (Sentinel Agent – Hybrid DC + Simple + ML + Sentiment per Refs B/G + Chen/Tsang + L/N)
- **Core: Directional Change (DC) + 2-state HMM** (Chen/Tsang Ch3–6):  
  - DC threshold θ=0.3% (event-driven: new regime if price reverses >θ from extremum).  
  - Indicators: TMV (time to max vol), T (trend time), R (time-adj return); normalize [0,1].  
  - HMM: 2 states (normal/abnormal); emissions on TMV/T/R; fit via depmixS4.  
  - Online tracking: Naïve-Bayes on completed + unfinished DC (B-Strict rule: alarm if P(abnormal)>0.7 for ≥3 events).  
- **Hybrid layers (weighted 50% DC, 20% simple, 20% ML, 10% sentiment)**:  
  - Simple: ADX<14 (range), 14–27 (mean-rev), >27 (trend); IV<45%, BBW<0.5x avg; RV/IV<0.8; RSI extremes; chaos if ≥4 triggers.  
  - ML: Prob(chaos)>0.85 vetoes short-vol.  
  - Sentiment (Yang SMEI, Ref G): Enhanced OBV = vol*(close-open)/(high-low); CMF variant = cum vol*((close-low)-(high-close))/(high-low) over 20d, norm [-1,1]. Score>0.5 bullish (short-vol ok); <-0.5 bearish (directional only).  
- **Updates (Refs L/N)**: Triggers (e.g., correlation >0.85, events) require ≥2 consecutive days for chaos veto; single-day = Warning (tighten size).  
- Decision: Short-vol if DC/normal + ≥2 others agree; else directional/hedge. Log disagreements for Monk.  
- Refresh: EOD + 15min intraday; pre-scan events (FOMC, earnings).

#### Entry/Exit
- Entry: Confluence ≥2 (regime + structure); 9:30–11:00 IST.  
- Targets: Short-vol 1.4–1.8% (low VIX); directional 1.4–2.2%.  
- Exits: Target/trailing; regime shift (DC alarm or ADX cross).  
- **Adjustments (Refs A/H – Bachelier/Passarelli probabilistic)**: If P&L≤–0.5% + regime stable → roll 5-delta or condor; post: tighten 75%. Hedge if gamma/vega breach + prob(profit)=1-(vega/IV perc)*(days/30)<0.4.  
- **Patience (Ref C)**: Extend short-vol to 50% theta if P&L>–0.3%, no event, hold<7d post-target.  
- Stops: Greeks breach; hard –1.5% risk.
- **Updates (Refs J/K/M)**: Allow entry on event if DTE≥10 (override ban); if IV %ile>50th + VIX>avg+5%, boost short-vol target 1.8–2.2%, tighten adjust to –0.3%. For NIFTY, if call IV > put IV +5%, favor risk-reversals.

#### Sizing (Treasury – Kelly per Refs D/E/F/I + N)
- Risk: Kelly f = (win_p*avg_win - loss_p*avg_loss)/(avg_win*loss_p); fractional 0.5–0.7x (start 0.5).  
- Lots: 1 (reboot) to 3 on 3+ positive weeks; max 20% margin.  
- **Adjustments**: Rolling 30-trade est (win_p 60–70%, etc.); regime multipliers (DC normal=1.0x, abnormal=0.3x); commodities contango complement +1.1x if positive (Ref I).  
- Psych: Cap 1 lot if drawdown >–2% or sentiment <–0.3. On warning (Ref N), tighten to 1 lot.

#### Brakes
- Daily: –1.5% flatten.  
- Weekly: –4% flat 3 days.  
- Chaos: DC abnormal >2 days flat 48hr.  
- Monthly: >–8% pause + Monk audit.

#### Bans
- Naked/averaging/discretionary; >3x leverage; event-day entries (unless Ref J override).  
- No ML/DC-only (hybrid enforced).

#### Monitoring
- Real-time: P&L, Greeks (via API pulls); alerts on breaches.  
- EOD: Win rate >60%, Sharpe >1.0 (rolling 30-day); journal regime hits/misses.  
- Weekly: Agent logs (adjustment efficacy); psychology check (e.g., no manual tweaks).

#### Backtesting (Monk Agent)
- Data: 5+ years (NSE historical options/futures, adjusted for splits/divs).  
- Metrics: Sharpe >1.0, drawdown <15%, win rate >60%, Calmar >0.8; stress (2020 crash, 2022 vol spike).  
- **Incorporate refinements: Sim adjustments (60% recovery rate), hybrid veto (–2 false positives/month), patience holds (+15–25% theta capture).**  
- Frequency: Pre-entry validation; post-week audit.

#### Trailing
- Activate >50% target.  
- Directional: ATR ±0.5x from entry.  
- Short-vol: BBW >1.8x avg → exit; **post-adjustment tighten to 75% remaining.**  
- **Patience: Theta-based (50% capture cap).**

### Updated Agent Design: Inputs/Conditions/Outputs (For Coding)
Agents as modular Python classes (e.g., via backtrader/Zerodha Kite API hooks). Each has strict I/O to enforce rules—no fuzzy logic. Use pandas for data, scikit-learn for ML veto, hmmlearn for HMM. Skeleton pseudocode below; full impl expandable on request.

#### 1. Sentinel (Regime Classifier)
- **Purpose:** Hybrid regime ID; veto layer for entries.  
- **Inputs:**  
  - Dataframe: OHLCV (1min/5min), Greeks (from options chain), features (ADX, BBW, RSI, IV/RV, VIX, corr matrix).  
  - Timestamp: Current IST.  
  - ML model: Pre-trained (e.g., RandomForest on lagged vol/skew).  
- **Conditions:**  
  - Simple: If ADX<14 & IV<45% & ... → regime='range'; else if ≥4 flips → 'chaos' (Ref N: ≥2 days sustained).  
  - ML: prob_chaos = model.predict_proba(features); veto if >0.85.  
  - Hybrid: non-chaos = (simple!='chaos') & (ML<0.85).  
- **Outputs:**  
  - Dict: {'regime': 'range/mean/trend/chaos', 'confidence': 0–1, 'veto_shortvol': bool, 'disagreement_log': list[features_diff]}.  
- **Pseudocode Snippet:**  
  ```python
  import hmmlearn.hmm as hmm
  class Sentinel:
      def __init__(self, ml_model):
          self.ml_model = ml_model
      def classify(self, df_data, ts):
          simple_regime = self._simple_indicators(df_data)  # ADX/BBW/etc.
          ml_prob = self.ml_model.predict_proba(df_data[features])[0][1]  # chaos class
          dc_events = self._compute_dc(df_data, theta=0.003)  # Refs Chen/Tsang
          hmm_prob_abnormal = self._fit_hmm(dc_events[['T','OS','TAR']])
          sent_score = self._smei(df_data)  # Ref G Yang
          hybrid = {'regime': 'normal' if simple_regime!='chaos' and ml_prob < 0.85 and hmm_prob_abnormal < 0.7 and abs(sent_score)<0.5 else 'abnormal',
                    'veto_shortvol': ml_prob >= 0.85 or simple_regime == 'chaos' or hmm_prob_abnormal >= 0.7,
                    'disagreement_log': [...] if simple_regime != 'chaos' and ml_prob >= 0.85 else []}
          # Ref N: if trigger sustained <2 days, hybrid['regime'] = 'warning'
          return hybrid
  ```

#### 2. Strategist (Signals/Allocation)
- **Purpose:** Generate entry/exit signals + structure selection.  
- **Inputs:**  
  - Sentinel output (regime dict).  
  - Portfolio state: Current positions, margin used, P&L.  
  - Confluence score: ≥2 metrics (e.g., from regime).  
- **Conditions:**  
  - Entry: regime non-chaos & confluence≥2 & margin<20% (Ref J: override event if DTE>=10).  
  - Structure: If range → short strangle; trend → risk-reversal (Ref M: skew check for NIFTY).  
  - Adjustment (Ref A): If P&L≤–0.5% & regime stable → 'roll' or 'condor' (Ref K: tighten to –0.3% on high IV).  
  - Patience (Ref C): If short-vol & P&L>–0.3% & hold<7d → 'extend'.  
- **Outputs:**  
  - List: [{'action': 'entry/exit/adjust/extend', 'structure': 'strangle', 'instrument': 'NIFTY', 'delta': 30, 'size': 1, 'target': 1.6}].  
- **Pseudocode Snippet:**  
  ```python
  class Strategist:
      def generate(self, sentinel_out, portfolio):
          signals = []
          if sentinel_out['veto_shortvol'] or sentinel_out['regime'] == 'chaos':  # Ref B
              return [{'action': 'hedge', 'structure': 'straddle'}]  # Fallback
          if portfolio.pnl <= -0.005 * margin and not sentinel_out['veto_shortvol']:  # Ref A/K
              adjust_thresh = -0.003 if iv_perc > 50 else -0.005  # High-IV tighten
              signals.append({'action': 'adjust', 'type': 'roll_delta_5'})
          # ... similar for entry/exit/patience; Ref J: check DTE >=10 for event override
          return signals
  ```

#### 3. Executor (Orders)
- **Purpose:** Place/monitor orders; enforce brakes.  
- **Inputs:**  
  - Strategist signals (action list).  
  - Real-time data: Quotes, Greeks.  
  - Brakes: Daily/weekly P&L thresholds.  
- **Conditions:**  
  - Validate: Size≤3 lots, risk≤1.5%, no bans (Ref J override).  
  - If brake (e.g., daily –1.5%) → 'flatten_all'.  
  - Post-adjust: Tighten trailing 75%.  
- **Outputs:**  
  - Order dicts: [{'order_type': 'sell', 'symbol': 'NIFTY25FEB24500CE', 'qty': 1, 'price': market, 'status': 'placed'}]; log file.  
- **Pseudocode Snippet:**  
  ```python
  class Executor:
      def execute(self, signals, data, brakes):
          orders = []
          for sig in signals:
              if brakes['daily'] < -0.015:  # Flatten override
                  orders.append(self._flatten_portfolio())
                  break
              order = self._build_order(sig, data)  # e.g., kite.place_order()
              orders.append(order)
          return orders
  ```

#### 4. Monk (Backtesting/Learning)
- **Purpose:** Sim/historical tests; retrain ML.  
- **Inputs:**  
  - Historical data: 5y CSV (OHLC, options chains).  
  - Rulebook params (e.g., targets, refinements).  
  - Logs: Disagreements from Sentinel.  
- **Conditions:**  
  - Run vectorized (e.g., via vectorbt): Apply entries/exits/adjusts.  
  - Metrics: Sharpe = (mean_ret - rf)/std_ret; drawdown = cummax - cumsum.  
  - Retrain: If >5 disagreements/week → refit ML on new features.  
- **Outputs:**  
  - Report: {'sharpe': 1.2, 'drawdown_max': 12%, 'win_rate': 62%, 'trades': 150, 'refinement_impact': {'A': '+1.2%', 'B': '-0.3% false_pos', 'C': '+18% theta'}}; plot PNG.  
- **Pseudocode Snippet:**  
  ```python
  import vectorbt as vbt
  class Monk:
      def backtest(self, data, rules):
          entries = self._signal_entries(data, rules)  # From Strategist logic
          pf = vbt.Portfolio.from_signals(data['close'], entries, exits=...)
          metrics = {'sharpe': pf.sharpe_ratio(), 'drawdown': pf.max_drawdown()}
          # Refinement sim: e.g., adjust_recover = sum(recovered_strangles) / total
          return metrics
  ```

#### 5. Treasury (Risk/Capital)
- **Purpose:** Capital allocation, Greeks caps, psych safeguards.  
- **Inputs:**  
  - All agent outputs (signals, orders, metrics).  
  - Portfolio: Total capital, current exposure.  
- **Conditions:**  
  - Risk: Kelly_fraction = (win_p * avg_win - loss_p * avg_loss) / (avg_win * loss_p); cap at 1.5%.  
  - Greeks: Portfolio delta/vega sum < caps; hedge if breach.  
  - Psych: If drawdown >–2% weekly → force tiny size (1 lot).  
- **Outputs:**  
  - Alloc dict: {'approved_size': 2, 'hedge_needed': True, 'kelly_fraction': 0.012, 'brake_active': False}.  
- **Pseudocode Snippet:**  
  ```python
  class Treasury:
      def allocate(self, signals, greeks, capital):
          risk_per = 0.015 * capital
          size = min(int(risk_per / (sig['target'] * margin_req)), 3)
          if sum(greeks['delta']) > 0.15:
              return {'hedge_needed': True, 'approved_size': size}
          return {'approved_size': size}
  ```

**Integration Flow:** Sentinel → Strategist → Treasury (validate) → Executor → Monk (post-hoc). Run in loop (e.g., APScheduler every 15min). Total code footprint: ~600 LOC base; refinements add 150.

Brutal feedback: This is now v1-loss-proof (adjustments cap gamma/vega hits; hybrid avoids ML overreach; patience fixes hold-too-long psych). But test Ref K on 2022 vol spike data first—expect 55% recovery, not 60% if skew was extreme.

Next step options: "Paper Phase 1 plan"? "Code full Monk"? "Forensic on open Gold/Silver"? Your call.